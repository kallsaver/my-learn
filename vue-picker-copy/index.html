<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Document</title>
	<style>
		.area_ctrl {
			font-size: 12px;
		}

		.btn {
			width: 80%;
			height: 34px;
			line-height: 34px;
			text-align: center;
			color: #fff;
			background: #0575f2;
			margin: 10px auto;
			border-radius: 4px;
		}

	</style>
	<link rel="stylesheet" href="css/picker.css">
</head>

<body>
	<div id="app" v-cloak>
        <p class="btn" @click="example1">单列picker</p>
        <!-- v-bind:name-aa 不能使用驼峰命名 -->
		<vue-pickers :show="show1" :select-data="pickData1" v-on:cancel="close" v-on:confirm="confirmFn"></vue-pickers>
	</div>
</body>
<script src="js/vue2.0.js"></script>
<script src="js/areaData.js"></script>
<script>
	Vue.component('vue-pickers', {
		template:  `<div id="">
                        <div class="area_ctrl" :class="show ? 'slideInUp' : 'slideInDown'">
                        <div class="area_btn_box">
                            <div class="area_btn larea_cancel" @click="close">取消</div>
                            <div class="area_btn larea_finish" @click="finish">确定</div>
                        </div>
                        <div class="area_roll_mask">
                            <div class="area_roll">
                            <div>
                                <div top="0" class="gear area_province"
                                    data-areatype="area_province"
                                    data-type="provs"
                                    :data-len="pData1.length"
                                    val="5"
                                    @touchstart="gearTouchStart"
                                    @touchmove="gearTouchMove"
                                    @touchend="gearTouchEnd">
                                <div class="tooth" v-for="item in pData1">{{item.text}}</div>
                                </div>
                                <div class="area_grid">
                                </div>
                            </div>
                            <div v-if="selectData.columns > 1">
                                <div class="gear area_city" top="0" data-areatype="area_city" data-type="city"
                                    :data-len="pData2.length"
                                    @touchstart="gearTouchStart"
                                    @touchmove="gearTouchMove"
                                    @touchend="gearTouchEnd"
                                    val="5">
                                <div class="tooth" v-for="item in pData2">{{item.text}}</div>
                                </div>
                                <div class="area_grid">
                                </div>
                            </div>
                            <div v-if="selectData.columns > 2">
                                <div class="gear area_county" top="0" data-areatype="area_county" :data-len="pData3.length"
                                    @touchstart="gearTouchStart"
                                    @touchmove="gearTouchMove"
                                    @touchend="gearTouchEnd"
                                    val="5">
                                <div class="tooth" v-for="item in pData3">{{item.text}}</div>
                                </div>
                                <div class="area_grid">
                                </div>
                            </div>
                            </div>
                        </div>
                        </div>
                    </div>`,
        props: {
            show: {
                type: Boolean,
                default: function(){
                    return false
                }
            },
            selectData: {
                type: Object,
                default: function(){
                    return {}
                }
            }
        },
        //props : ['show','selectData'],
		data: function () {
			return {
				pData1: [],
				pData2: [],
				pData3: [],
				selects: {
					select1: '',
					select2: '',
					select3: ''
				},
				noData: false
			}
		},
		methods: {
			close: function (e) {
				this.$emit('cancel')
				e.preventDefault();
			},
			finish: function (e) {
				this.$emit('confirm', this.selects)
				e.preventDefault();
			},
			gearTouchStart: function (e) {
				e.preventDefault();
				var target = e.target;
				while (true) {
					if (!target.classList.contains("gear")) {
						target = target.parentElement;
					} else {
						break
					}
				}
				clearInterval(target["int_" + target.id]);
				target["old_" + target.id] = e.targetTouches[0].screenY;
				target["o_t_" + target.id] = (
					new Date()).getTime();
				var top = target.getAttribute('top');
				if (top) {
					target["o_d_" + target.id] = parseFloat(top.replace(/em/g, ""));
				} else {
					target["o_d_" + target.id] = 0;
				}
				target.style.webkitTransitionDuration = target.style.transitionDuration = '0ms';
			},
			//手指移动
			gearTouchMove: function (e) {
				e.preventDefault();
				var target = e.target;
				while (true) {
					if (!target.classList.contains("gear")) {
						target = target.parentElement;
					} else {
						break
					}
				}
				target["new_" + target.id] = e.targetTouches[0].screenY;
				target["n_t_" + target.id] = (
					new Date()).getTime();
				var f = (
					target["new_" + target.id] - target["old_" + target.id]) * 30 / window.innerHeight;
				target["pos_" + target.id] = target["o_d_" + target.id] + f;
				target.style["-webkit-transform"] = 'translate3d(0,' + target["pos_" + target.id] + 'em,0)';
				target.setAttribute('top', target["pos_" + target.id] + 'em');
				if (e.targetTouches[0].screenY < 1) {
					gearTouchEnd(e);
				}
			},
			gearTouchEnd: function (e) {
				e.preventDefault();
				var target = e.target;
				while (true) {
					if (!target.classList.contains("gear")) {
						target = target.parentElement;
					} else {
						break;
					}
				}
				var flag = (
					target["new_" + target.id] - target["old_" + target.id]) / (
					target["n_t_" + target.id] - target["o_t_" + target.id]);
				if (Math.abs(flag) <= 0.2) {
					target["spd_" + target.id] = (
						flag < 0 ? -0.08 : 0.08);
				} else {
					if (Math.abs(flag) <= 0.5) {
						target["spd_" + target.id] = (
							flag < 0 ? -0.16 : 0.16);
					} else {
						target["spd_" + target.id] = flag / 2;
					}
				}
				if (!target["pos_" + target.id]) {
					target["pos_" + target.id] = 0;
				}
				this.rollGear(target);
			},
			rollGear: function (target) {
				var _this = this
				var d = 0;
				var stopGear = false;

				function setDuration() {
					target.style.webkitTransitionDuration = target.style.transitionDuration = '200ms';
					stopGear = true;
				}

				clearInterval(target["int_" + target.id]);
				target["int_" + target.id] = setInterval(function () {
					var pos = target["pos_" + target.id];
					var speed = target["spd_" + target.id] * Math.exp(-0.03 * d);
					pos += speed;
					if (Math.abs(speed) > 0.1) {} else {
						var b = Math.round(pos / 2) * 2;
						pos = b;
						setDuration();
					}
					if (pos > 0) {
						pos = 0;
						setDuration();
					}
					var minTop = -(
						target.dataset.len - 1) * 2;
					if (pos < minTop) {
						pos = minTop;
						setDuration();
					}
					if (stopGear) {
						var gearVal = Math.abs(pos) / 2;
						_this.setGear(target, gearVal);
						clearInterval(target["int_" + target.id]);
					}
					target["pos_" + target.id] = pos;
					target.style["-webkit-transform"] = 'translate3d(0,' + pos + 'em,0)';
					target.setAttribute('top', pos + 'em');
					d++;
				}, 30);
			},
			setGear: function (target, val) {
				var _self = this
				var endVal = Math.round(val);
				var type = target.getAttribute('data-type')
				// 不是联级
				if (!this.selectData.link) {
					if (type === 'provs') {
						_self.selects.select1 = _self.pData1[endVal]
					} else if (type === 'city') {
						_self.selects.select2 = _self.pData2[endVal]
					} else {
						_self.selects.select3 = _self.pData3[endVal]
					}
				} else {
					if (type === 'provs') {
						_self.selects.select1 = _self.pData1[endVal]
						_self.resetData2(endVal)
						if (this.selectData.columns === 3) {
							_self.resetData3(0)
						}
					} else if (type === 'city' && this.selectData.columns === 2) {
						this.selects.select2 = this.pData2[endVal]
					} else if (type === 'city' && this.selectData.columns === 3) {
						_self.resetData3(endVal)
						this.selects.select2 = this.pData2[endVal]
					} else if (this.selectData.columns === 3) {
						this.selects.select3 = this.pData3[endVal]
					}
				}
			},
			resetData2: function (endVal) {
				var city = document.querySelector('.area_city')
				if (this.selectData.pData2[this.pData1[endVal].value]) {
					this.pData2 = this.selectData.pData2[this.pData1[endVal].value]
				} else {
					this.pData2 = []
				}
				this.selects.select2 = this.pData2[0]
				city.setAttribute('top', 0);
				city.style["-webkit-transform"] = 'translate3d(0, 0, 0)';
			},
			resetData3: function (endVal) {
				var county = document.querySelector('.area_county')
				if (this.pData2.length > 0 && this.pData2[endVal]) {
					this.pData3 = this.selectData.pData3[this.pData2[endVal].value]
				} else {
					this.pData3 = []
				}
				this.selects.select3 = this.pData3[0]
				county.setAttribute('top', 0);
				county.style["-webkit-transform"] = 'translate3d(0, 0, 0)';
			},
			init: function () {
				if (!this.selectData.link) {
                    this.pData1 = this.selectData.pData1;
                    console.log( this.pData1 )
                    return;
					// this.pData2 = this.selectData.pData2;
					// this.pData3 = this.selectData.pData3;
				} else {
                    this.pData1 = this.selectData.pData1;
					// this.pData2 = this.selectData.pData2[this.pData1[0].value]
					// if (this.selectData.columns === 3) {
					// 	this.pData3 = this.selectData.pData3[this.pData2[0].value]
					// }
				}
				this.selects.select1 = this.pData1[0]
				// if (this.selectData.columns === 2) {
				// 	this.selects.select2 = this.pData2[0]
				// } else if (this.selectData.columns === 3) {
				// 	this.selects.select2 = this.pData2[0]
				// 	this.selects.select3 = this.pData3[0]
				// }
			}
		},
		created: function () {
            console.log(this.$props);
			this.init()
		}
	});


	new Vue({
        el: '#app',
        data: {
            selectStr: '',
            show1: false,
            show2: false,
            show3: false,
            show4: false,
            show5: false,
            pickData1: {
                columns: 1,
                pData1: [{
                        text: 1999,
                        value: 1999
                    },
                    {
                        text: 2001,
                        value: 2001
                    },
                    {
                        text: 2002,
                        value: 2002
                    },
                    {
                        text: 2003,
                        value: 2003
                    },
                    {
                        text: 2004,
                        value: 2004
                    },
                    {
                        text: 2005,
                        value: 2005
                    },
                ]
            },
            pickData2: {
                columns: 2,
                link: true,
                pData1: [
                    {
                        text: '数码',
                        value: 1999
                    },
                    {
                        text: '水果',
                        value: 2001
                    },
                    {
                        text: '衣服',
                        value: 2002
                    }
                ],
                pData2: {
                    '1999': [{
                            text: '相机',
                            value: 101
                        },
                        {
                            text: '手机',
                            value: 102
                        },
                        {
                            text: '音箱',
                            value: 103
                        }
                    ],
                    '2001': [{
                            text: '苹果',
                            value: 104
                        },
                        {
                            text: '香蕉',
                            value: 105
                        },
                        {
                            text: '西红柿',
                            value: 106
                        }
                    ],
                    '2002': [{
                            text: '衬衫',
                            value: 107
                        },
                        {
                            text: '短裤',
                            value: 108
                        },
                        {
                            text: '上衣',
                            value: 109
                        }
                    ]
                }
            },
            pickData3: {
                columns: 3,
                link: true,
                pData1: provs_data,
                pData2: citys_data,
                pData3: dists_data,
            },
            pickData4: {
                columns: 2,
                pData1: [{
                        text: '上午',
                        value: 1999
                    },
                    {
                        text: '下午',
                        value: 2001
                    }
                ],
                pData2: [{
                        text: '1',
                        value: 1
                    },
                    {
                        text: '2',
                        value: 2
                    },
                    {
                        text: '3',
                        value: 3
                    },
                    {
                        text: '4',
                        value: 4
                    },
                    {
                        text: '5',
                        value: 5
                    },
                    {
                        text: '6',
                        value: 6
                    }
                ]
            },
            pickData5: {
                columns: 3,
                pData1: [
                    {
                        text: '1999年',
                        value: 1999
                    },
                    {
                        text: '2001年',
                        value: 2001
                    },
                    {
                        text: '2002年',
                        value: 2002
                    },
                    {
                        text: '2003年',
                        value: 2003
                    },
                    {
                        text: '2004年',
                        value: 2004
                    },
                    {
                        text: '2005年',
                        value: 2005
                    },
                ],
                pData2: [{
                        text: '01月',
                        value: 1
                    },
                    {
                        text: '02月',
                        value: 2
                    },
                    {
                        text: '03月',
                        value: 3
                    },
                    {
                        text: '04月',
                        value: 4
                    },
                    {
                        text: '05月',
                        value: 5
                    },
                    {
                        text: '06月',
                        value: 6
                    },
                ],
                pData3: [{
                        text: '01',
                        value: 1
                    },
                    {
                        text: '02',
                        value: 2
                    },
                    {
                        text: '03',
                        value: 3
                    },
                    {
                        text: '04',
                        value: 4
                    },
                    {
                        text: '05',
                        value: 5
                    },
                    {
                        text: '06',
                        value: 6
                    },
                ]
            },
        },
        methods: {
            close: function () {
                this.show1 = false
                this.show2 = false
                this.show3 = false
                this.show4 = false
                this.show5 = false
            },
            confirmFn: function (data) {
                this.selectStr = data.select1.text
                console.log(data)
                if (data.select2) {
                    this.selectStr += '-' + data.select2.text
                }
                if (data.select3) {
                    this.selectStr += '-' + data.select3.text
                }
                this.close();
            },
            example1: function () {
                this.show1 = true
            },
            example2: function () {
                this.show2 = true
            },
            example3: function () {
                this.show3 = true
            },
            example4: function () {
                this.show4 = true
            },
            example5: function () {
                this.show5 = true
            }
        }
    });

</script>

</html>
